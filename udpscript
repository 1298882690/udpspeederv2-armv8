#!/bin/bash
# udp-tunnel-manager.sh - OpenWRT/Debian通用udpspeeder+udp2raw管理脚本

set -e  # 遇到错误立即退出

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 系统检测变量
OS_TYPE=""
ARCH=""
INIT_SYSTEM=""
BIN_DIR="/usr/bin"
CONFIG_DIR="/etc/udp-tunnel"
LOG_DIR="/var/log/udp-tunnel"
SERVICE_USER="nobody"

# 版本配置
UDPSPEEDER_VERSION="20230206.0"
UDP2RAW_VERSION="20230206.0"
REPO_BASE="https://github.com/wangyu-"

# 日志函数
log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_step() { echo -e "${BLUE}[STEP]${NC} $1"; }

# 检测运行环境
detect_environment() {
    log_step "检测系统环境..."
    
    # 检测操作系统
    if [ -f "/etc/openwrt_release" ]; then
        OS_TYPE="openwrt"
        BIN_DIR="/usr/bin"
        CONFIG_DIR="/etc/udp-tunnel"
        LOG_DIR="/tmp/udp-tunnel"
        INIT_SYSTEM="procd"
        log_info "检测到OpenWRT系统"
    elif [ -f "/etc/debian_version" ]; then
        OS_TYPE="debian"
        BIN_DIR="/usr/local/bin"
        CONFIG_DIR="/etc/udp-tunnel"
        LOG_DIR="/var/log/udp-tunnel"
        INIT_SYSTEM="systemd"
        log_info "检测到Debian系统"
    else
        log_error "不支持的操作系统"
        exit 1
    fi
    
    # 检测架构
    ARCH=$(uname -m)
    case $ARCH in
        x86_64|amd64) ARCH="amd64" ;;
        aarch64|arm64) ARCH="arm64" ;;
        armv7l|armhf) ARCH="arm" ;;
        mips|mips_be) ARCH="mips_be" ;;
        mipsle|mips_le) ARCH="mips_le" ;;
        *) 
            log_warn "未知架构: $ARCH，使用通用配置"
            ARCH="generic"
            ;;
    esac
    log_info "系统架构: $ARCH"
    
    # 创建必要目录
    mkdir -p $CONFIG_DIR $LOG_DIR
}

# 功能1: 下载并安装
install_binaries() {
    log_step "开始下载并安装二进制文件..."
    
    # 用户选择角色
    echo "请选择角色:"
    echo "  1. 客户端 (Client)"
    echo "  2. 服务端 (Server)"
    read -p "请输入选择 (1/2): " ROLE_CHOICE
    
    if [ "$ROLE_CHOICE" = "1" ]; then
        ROLE="client"
        log_info "配置为客户端"
    elif [ "$ROLE_CHOICE" = "2" ]; then
        ROLE="server"
        log_info "配置为服务端"
    else
        log_error "无效的选择"
        return 1
    fi
    
    # 下载udpspeeder
    log_info "下载udpspeeder..."
    UDPSPEEDER_URL="${REPO_BASE}UDPspeeder/releases/download/${UDPSPEEDER_VERSION}/speederv2_${ARCH}.tar.gz"
    if wget -q --timeout=10 --tries=3 -O /tmp/speederv2.tar.gz "$UDPSPEEDER_URL"; then
        log_info "下载udpspeeder成功"
    else
        log_error "下载udpspeeder失败，尝试备用源..."
        # 这里可以添加备用下载源
        return 1
    fi
    
    # 下载udp2raw
    log_info "下载udp2raw..."
    UDP2RAW_URL="${REPO_BASE}udp2raw-tunnel/releases/download/${UDP2RAW_VERSION}/udp2raw_binaries.tar.gz"
    if wget -q --timeout=10 --tries=3 -O /tmp/udp2raw.tar.gz "$UDP2RAW_URL"; then
        log_info "下载udp2raw成功"
    else
        log_error "下载udp2raw失败"
        return 1
    fi
    
    # 解压并安装
    log_info "解压文件..."
    tar -xzf /tmp/speederv2.tar.gz -C /tmp/
    tar -xzf /tmp/udp2raw.tar.gz -C /tmp/
    
    # 查找二进制文件
    SPEEDER_BIN=$(find /tmp -name "speederv2_*" -type f 2>/dev/null | head -1)
    UDP2RAW_BIN=$(find /tmp -name "udp2raw_*" -type f 2>/dev/null | head -1)
    
    if [ -z "$SPEEDER_BIN" ] || [ -z "$UDP2RAW_BIN" ]; then
        log_error "未找到二进制文件"
        return 1
    fi
    
    # 安装到系统目录
    log_info "安装二进制文件到 $BIN_DIR"
    install -m 755 "$SPEEDER_BIN" "$BIN_DIR/speederv2"
    install -m 755 "$UDP2RAW_BIN" "$BIN_DIR/udp2raw"
    
    # 验证安装
    if command -v speederv2 >/dev/null 2>&1 && command -v udp2raw >/dev/null 2>&1; then
        log_info "安装成功!"
        echo "udpspeeder版本: $(speederv2 -h 2>&1 | head -1)"
        echo "udp2raw版本: $(udp2raw -h 2>&1 | head -1)"
        return 0
    else
        log_error "安装验证失败"
        return 1
    fi
}

# 功能2: 配置系统服务
configure_services() {
    log_step "配置系统服务..."
    
    # 获取用户配置
    read -p "请输入服务密码: " SERVICE_PASS
    read -p "请输入服务端口 (默认: 3333): " SERVICE_PORT
    SERVICE_PORT=${SERVICE_PORT:-3333}
    
    # 根据角色创建配置文件
    if [ "$ROLE" = "client" ]; then
        read -p "请输入服务器IP地址: " SERVER_IP
        
        cat > $CONFIG_DIR/client.conf << EOF
# udpspeeder客户端配置
SPEEDER_MODE="-c"
SPEEDER_OPTIONS="-l0.0.0.0:${SERVICE_PORT} -r127.0.0.1:$((SERVICE_PORT+1)) -f20:10 -k\"${SERVICE_PASS}\""

# udp2raw客户端配置
UDP2RAW_MODE="-c"
UDP2RAW_OPTIONS="-l0.0.0.0:$((SERVICE_PORT+1)) -r${SERVER_IP}:$((SERVICE_PORT+2)) -k\"${SERVICE_PASS}\" --raw-mode faketcp"
EOF
        log_info "客户端配置文件已创建: $CONFIG_DIR/client.conf"
    else
        cat > $CONFIG_DIR/server.conf << EOF
# udpspeeder服务端配置
SPEEDER_MODE="-s"
SPEEDER_OPTIONS="-l0.0.0.0:$((SERVICE_PORT+1)) -r127.0.0.1:$((SERVICE_PORT+2)) -f20:10 -k\"${SERVICE_PASS}\""

# udp2raw服务端配置
UDP2RAW_MODE="-s"
UDP2RAW_OPTIONS="-l0.0.0.0:$((SERVICE_PORT+2)) -r127.0.0.1:$((SERVICE_PORT+3)) -k\"${SERVICE_PASS}\" --raw-mode faketcp"
EOF
        log_info "服务端配置文件已创建: $CONFIG_DIR/server.conf"
    fi
    
    # 创建启动脚本
    create_startup_scripts
    
    # 根据初始化系统创建服务
    case $INIT_SYSTEM in
        systemd)
            create_systemd_service
            ;;
        procd)
            create_procd_service
            ;;
    esac
    
    log_info "服务配置完成"
}

# 创建启动脚本
create_startup_scripts() {
    log_info "创建启动脚本..."
    
    cat > $BIN_DIR/start-udp-tunnel.sh << 'EOF'
#!/bin/bash
CONFIG_DIR="/etc/udp-tunnel"
LOG_DIR="/var/log/udp-tunnel"

# 读取配置
if [ -f "$CONFIG_DIR/client.conf" ]; then
    source $CONFIG_DIR/client.conf
    ROLE="client"
elif [ -f "$CONFIG_DIR/server.conf" ]; then
    source $CONFIG_DIR/server.conf
    ROLE="server"
else
    echo "未找到配置文件"
    exit 1
fi

# 启动udp2raw
echo "启动udp2raw ($ROLE)..."
eval "udp2raw $UDP2RAW_MODE $UDP2RAW_OPTIONS" > $LOG_DIR/udp2raw.log 2>&1 &
UDP2RAW_PID=$!

# 等待udp2raw启动
sleep 2

# 启动udpspeeder
echo "启动udpspeeder ($ROLE)..."
eval "speederv2 $SPEEDER_MODE $SPEEDER_OPTIONS" > $LOG_DIR/speederv2.log 2>&1 &
SPEEDER_PID=$!

# 保存PID
echo $UDP2RAW_PID > /var/run/udp2raw.pid
echo $SPEEDER_PID > /var/run/speederv2.pid

echo "服务启动完成"
echo "udp2raw PID: $UDP2RAW_PID"
echo "speederv2 PID: $SPEEDER_PID"
EOF
    
    chmod +x $BIN_DIR/start-udp-tunnel.sh
}

# 创建systemd服务
create_systemd_service() {
    log_info "创建systemd服务..."
    
    cat > /etc/systemd/system/udp-tunnel.service << EOF
[Unit]
Description=UDP Tunnel (udpspeeder+udp2raw)
After=network.target

[Service]
Type=forking
ExecStart=$BIN_DIR/start-udp-tunnel.sh
ExecStop=/bin/kill -TERM \$(cat /var/run/udp2raw.pid /var/run/speederv2.pid 2>/dev/null)
Restart=always
RestartSec=10
User=$SERVICE_USER

[Install]
WantedBy=multi-user.target
EOF
    
    systemctl daemon-reload
    systemctl enable udp-tunnel.service
    systemctl start udp-tunnel.service
    
    if systemctl is-active udp-tunnel.service >/dev/null 2>&1; then
        log_info "systemd服务启动成功"
    else
        log_error "systemd服务启动失败"
        journalctl -u udp-tunnel.service -n 20 --no-pager
    fi
}

# 创建procd服务 (OpenWRT)
create_procd_service() {
    log_info "创建procd服务..."
    
    cat > /etc/init.d/udp-tunnel << 'EOF'
#!/bin/sh /etc/rc.common

START=99
STOP=10

start() {
    $BIN_DIR/start-udp-tunnel.sh
}

stop() {
    kill \$(cat /var/run/udp2raw.pid 2>/dev/null) 2>/dev/null
    kill \$(cat /var/run/speederv2.pid 2>/dev/null) 2>/dev/null
    rm -f /var/run/udp2raw.pid /var/run/speederv2.pid
}

restart() {
    stop
    sleep 2
    start
}
EOF
    
    chmod +x /etc/init.d/udp-tunnel
    /etc/init.d/udp-tunnel enable
    /etc/init.d/udp-tunnel start
    
    if [ -f "/var/run/udp2raw.pid" ] && [ -f "/var/run/speederv2.pid" ]; then
        log_info "procd服务启动成功"
    else
        log_error "procd服务启动失败"
    fi
}

# 功能3: 检测运行状态
check_status() {
    log_step "检测服务运行状态..."
    
    # 检查进程
    echo "=== 进程状态 ==="
    if pgrep -x "speederv2" >/dev/null; then
        echo -e "udpspeeder: ${GREEN}运行中${NC} (PID: $(pgrep -x speederv2))"
    else
        echo -e "udpspeeder: ${RED}未运行${NC}"
    fi
    
    if pgrep -x "udp2raw" >/dev/null; then
        echo -e "udp2raw: ${GREEN}运行中${NC} (PID: $(pgrep -x udp2raw))"
    else
        echo -e "udp2raw: ${RED}未运行${NC}"
    fi
    
    # 检查端口监听
    echo -e "\n=== 端口监听状态 ==="
    echo "udp/tcp端口监听:"
    netstat -tunpl 2>/dev/null | grep -E "udp|tcp" | grep -E "$(pgrep -x speederv2|tr '\n' '|')|$(pgrep -x udp2raw|tr '\n' '|')" || echo "未找到相关端口监听"
    
    # 检查服务文件
    echo -e "\n=== 配置文件状态 ==="
    ls -la $CONFIG_DIR/ 2>/dev/null || echo "配置目录不存在"
    
    # 检查日志文件
    echo -e "\n=== 日志文件状态 ==="
    ls -la $LOG_DIR/ 2>/dev/null | head -10 || echo "日志目录不存在"
    
    # 系统服务状态
    echo -e "\n=== 系统服务状态 ==="
    case $INIT_SYSTEM in
        systemd)
            systemctl status udp-tunnel.service --no-pager | head -20
            ;;
        procd)
            /etc/init.d/udp-tunnel status 2>/dev/null || echo "procd服务状态检查失败"
            ;;
    esac
}

# 功能4: 查看日志
view_logs() {
    log_step "查看服务日志..."
    
    echo "请选择要查看的日志:"
    echo "  1. udpspeeder日志"
    echo "  2. udp2raw日志"
    echo "  3. 系统服务日志"
    echo "  4. 所有日志"
    read -p "请输入选择 (1-4): " LOG_CHOICE
    
    case $LOG_CHOICE in
        1)
            if [ -f "$LOG_DIR/speederv2.log" ]; then
                tail -50 $LOG_DIR/speederv2.log
            else
                log_error "udpspeeder日志不存在"
            fi
            ;;
        2)
            if [ -f "$LOG_DIR/udp2raw.log" ]; then
                tail -50 $LOG_DIR/udp2raw.log
            else
                log_error "udp2raw日志不存在"
            fi
            ;;
        3)
            case $INIT_SYSTEM in
                systemd)
                    journalctl -u udp-tunnel.service -n 50 --no-pager
                    ;;
                procd)
                    log_warn "OpenWRT请手动查看日志: cat $LOG_DIR/*.log"
                    cat $LOG_DIR/*.log 2>/dev/null | tail -50 || echo "无日志内容"
                    ;;
            esac
            ;;
        4)
            echo "=== udpspeeder日志 ==="
            tail -20 $LOG_DIR/speederv2.log 2>/dev/null || echo "无udpspeeder日志"
            echo -e "\n=== udp2raw日志 ==="
            tail -20 $LOG_DIR/udp2raw.log 2>/dev/null || echo "无udp2raw日志"
            ;;
        *)
            log_error "无效的选择"
            ;;
    esac
}

# 主菜单
show_menu() {
    clear
    echo "========================================="
    echo "  UDP隧道管理脚本 (OpenWRT/Debian通用)"
    echo "========================================="
    echo "当前系统: $OS_TYPE | 架构: $ARCH"
    echo "当前角色: ${ROLE:-未设置}"
    echo "-----------------------------------------"
    echo "  1. 下载并安装二进制文件"
    echo "  2. 配置系统服务"
    echo "  3. 检测运行状态"
    echo "  4. 查看服务日志"
    echo "  5. 启动/重启服务"
    echo "  6. 停止服务"
    echo "  7. 卸载服务"
    echo "  0. 退出"
    echo "========================================="
}

# 主函数
main() {
    # 检测环境
    detect_environment
    
    while true; do
        show_menu
        read -p "请选择操作 (0-7): " CHOICE
        
        case $CHOICE in
            1)
                install_binaries
                ;;
            2)
                if [ -z "$ROLE" ]; then
                    log_error "请先选择角色 (执行选项1)"
                else
                    configure_services
                fi
                ;;
            3)
                check_status
                ;;
            4)
                view_logs
                ;;
            5)
                log_step "启动服务..."
                case $INIT_SYSTEM in
                    systemd)
                        systemctl restart udp-tunnel.service
                        ;;
                    procd)
                        /etc/init.d/udp-tunnel restart
                        ;;
                esac
                sleep 2
                check_status
                ;;
            6)
                log_step "停止服务..."
                case $INIT_SYSTEM in
                    systemd)
                        systemctl stop udp-tunnel.service
                        ;;
                    procd)
                        /etc/init.d/udp-tunnel stop
                        ;;
                esac
                sleep 1
                check_status
                ;;
            7)
                log_step "卸载服务..."
                read -p "确认要卸载吗? (y/N): " CONFIRM
                if [ "$CONFIRM" = "y" ] || [ "$CONFIRM" = "Y" ]; then
                    # 停止服务
                    case $INIT_SYSTEM in
                        systemd)
                            systemctl stop udp-tunnel.service
                            systemctl disable udp-tunnel.service
                            rm -f /etc/systemd/system/udp-tunnel.service
                            systemctl daemon-reload
                            ;;
                        procd)
                            /etc/init.d/udp-tunnel stop
                            /etc/init.d/udp-tunnel disable
                            rm -f /etc/init.d/udp-tunnel
                            ;;
                    esac
                    
                    # 删除文件
                    rm -f $BIN_DIR/speederv2 $BIN_DIR/udp2raw $BIN_DIR/start-udp-tunnel.sh
                    rm -rf $CONFIG_DIR $LOG_DIR
                    rm -f /var/run/udp2raw.pid /var/run/speederv2.pid
                    
                    log_info "卸载完成"
                else
                    log_info "取消卸载"
                fi
                ;;
            0)
                log_info "退出脚本"
                exit 0
                ;;
            *)
                log_error "无效的选择"
                ;;
        esac
        
        echo -e "\n按回车键继续..."
        read
    done
}

# 脚本入口
main "$@"
